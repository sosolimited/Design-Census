<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.2/lodash.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>
  <style>

    html {
      font-size: 62.5%;     /* Brings it to 10px, since default is usually 16px. */
    }

    body {
      font-family: sans-serif;
      font-size: 1rem;
      color: black;
      background-color: white;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .dot {
      stroke: #000;
    }

    .label {
      font-size: 0.5rem;
    }

  </style>
</head>

<body>

    <h1>Data Tool</h1>

    <select id="data-selection-1">
      <option selected disabled>Select question for X axis</option>
    </select>
    <select id="data-selection-2">
      <option selected disabled>Select question for Y axis</option>
    </select>

    <div id="graph-area"></div>

  <script>

    var questions = undefined,
        responses = undefined,
        margin = {top: 20, right: 20, bottom:80, left: 300},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var svg = d3.select("#graph-area").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append('g')
        .attr('transform', 'translate('+ margin.left +','+ margin.top +')');

    d3.queue()
      .defer(d3.json, "data/wco-questions.json")
      .defer(d3.csv, "data/wco-responses-export.csv")
      .awaitAll(function(error, files) {
        parseData(files[0], files[1]);
      });

    function parseData(iQuestions, iResponses) {

      questions = iQuestions;
      responses = iResponses;

      var selectableQuestions = questions.filter(function(d){
        if (d.type === "range") { return true; }
        else if (d.type === "choice" && d.attributes.allow_multiple === false) { return true; }
        else { return false; }
      });

// debugger;
console.log('responses', responses)

      setupHTML(selectableQuestions);
      updateGraph(2, 3);

    }

    function setupHTML(iDropDownItems) {

      iDropDownItems.forEach(function(d, i) {
        $('#data-selection-1').append('<option data-question-id='+ d.question +'>'+ d.attributes.slug +'</option>');
        $('#data-selection-2').append('<option data-question-id='+ d.question +'>'+ d.attributes.slug +'</option>');
      });

      $("select").change(function() {
        var qId1 = $('#data-selection-1 option:selected').data('question-id');
        var qId2 = $('#data-selection-2 option:selected').data('question-id');
        if (qId1 !== undefined && qId2 !== undefined) {
          updateGraph(qId1, qId2);
        }
      });

    }

    function updateGraph(iQuestionNum1, iQuestionNum2) {

console.log('- updateGraph('+iQuestionNum1+', '+iQuestionNum2+')')

      // Part 1: prepare data

      // Get data for provided questions.
      var curQuestion1 = _.find(questions, {'question': iQuestionNum1});
      var curQuestion2 = _.find(questions, {'question': iQuestionNum2});
      var responseData = getResponseData(iQuestionNum1, iQuestionNum2);
      var domainQ1 = getQuestionDomain(iQuestionNum1);
      var domainQ2 = getQuestionDomain(iQuestionNum2);

// debugger;
console.log('responseData', responseData)

      // Part 2: create chart vars

      var xScale = d3.scale.linear().rangeRound([0, width]).domain(domainQ1);
      var yScale = d3.scale.ordinal().rangeRoundPoints([height, 0]).domain(domainQ2);

      var xAxis = d3.svg.axis().scale(xScale).orient('bottom');
      var yAxis = d3.svg.axis().scale(yScale).orient('left');

      // Part 3: draw chart items

      $(svg.node()).empty();

      svg.append('g')
          .attr('class', 'x axis')
          .attr('transform', 'translate(0,'+ height +')')
          .call(xAxis)
        .append('text')
          .attr('class', 'label')
          .attr('x', width)
          .attr('y', -6)
          .style('text-anchor', 'end')
          .text(curQuestion1.attributes.slug);

      svg.append('g')
          .attr('class', 'y axis')
          .call(yAxis)
        .append('text')
          .attr('class', 'label')
          .attr('transform', 'rotate(-90)')
          .attr('y', 6)
          .attr('dy', '.71em')
          .style('text-anchor', 'end')
          .text(curQuestion2.attributes.slug);

      svg.selectAll('.dot')
          .data(responseData)
        .enter().append('circle')
          .attr('class', 'dot')
          .attr('r', 3.5)
          .attr('cx', function(d){ return xScale(d.x); })
          .attr('cy', function(d){ return yScale(d.y); })
          .style('fill', 'red');



    }

    // Data notes:
    // - question.type = "range"    -->   data is NUMBERS
    // - question.type = "choice"   -->   data is STRINGS
    function getQuestionDomain(iQuestionNum) {

      var result = [];

      var curQuestion = _.find(questions, {'question': iQuestionNum});
      if (curQuestion.type === 'choice') {
        result = _.map(curQuestion.attributes.question_choice_options, 'title');
      } else if (curQuestion.type === 'range') {
        result = [curQuestion.attributes.min, curQuestion.attributes.max];
      }

      return result;

    }

    // For each response, combine answers to Q1 and Q2 into an array of response pairs.
    // Ex: [{response1answer1,response1answer2}, {response2answer1,response2answer2}, ...]
    function getResponseData(iQuestionNum1, iQuestionNum2) {

      var result = [];
      var q1Type = _.find(questions, {'question': iQuestionNum1}).type;
      var q2Type = _.find(questions, {'question': iQuestionNum2}).type;

      _.forEach(responses, function(response) {

        var curResult = {};

        _.forOwn(response, function(responseVal, question){

          // X
          if (Number(question.split('-')[0]) === Number(iQuestionNum1)) {
            if (responseVal !== '' && responseVal !== undefined) {
              if (q1Type === 'range') { responseVal = Number(responseVal); }
              curResult.x = responseVal;
            }
          }
          // Y
          if (Number(question.split('-')[0]) === Number(iQuestionNum2)) {
            if (responseVal !== '' && responseVal !== undefined) {
              if (q2Type === 'range') { responseVal = Number(responseVal); }
              curResult.y = responseVal;
            }
          }

        });

        // Check if result has X and Y before pushing.
        if (curResult.x !== undefined && curResult.y !== undefined) {
          result.push(curResult);
        }

      });

      return result;

    }

  </script>
</body>