<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.2/lodash.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
  </style>
</head>

<body>

    <h1>Data Tool</h1>

    <select id="data-selection-1">
    </select>
    <select id="data-selection-2">
    </select>

    <div id="graph-area"></div>

  <script>

    var questions = undefined,
        responses = undefined;

    var svg = d3.select("#graph-area").append("svg")
      .attr("width", 960)
      .attr("height", 500)

    svg.append("text")
      .text("Edit the code below to change me!")
      .attr("y", 200)
      .attr("x", 120)
      .style("font-size", 36)
      .style("font-family", "monospace")

    d3.queue()
      .defer(d3.json, "data/wco-questions.json")
      .defer(d3.csv, "data/wco-responses-export.csv")
      .awaitAll(function(error, files) {
        parseData(files[0], files[1]);
      });

    function parseData(iQuestions, iResponses) {

      questions = iQuestions;
      responses = iResponses;

      var selectableQuestions = questions.filter(function(d){
        if (d.type === "range") { return true; }
        else if (d.type === "choice" && d.attributes.allow_multiple === false) { return true; }
        else { return false; }
      });

debugger;

      setupHTML(selectableQuestions);
      updateGraph(3, 2);

    }

    function setupHTML(iDropDownItems) {

      iDropDownItems.forEach(function(d, i) {
        $("#data-selection-1").append("<option>"+ d.attributes.slug +"</option>");
        $("#data-selection-2").append("<option>"+ d.attributes.slug +"</option>");
      });

    }

    //"range" means numbers!
    function updateGraph(iQuestionNum1, iQuestionNum2) {

      // Get data for provided questions.
      var curQuestion1 = _.find(questions, {'question': iQuestionNum1});
      var curQuestion2 = _.find(questions, {'question': iQuestionNum2});
      var responseData = getResponseData(iQuestionNum1, iQuestionNum2);
      var domainQ1 = getQuestionDomain(iQuestionNum1);
      var domainQ2 = getQuestionDomain(iQuestionNum2);

debugger;

      var x = d3.scale.linear().rangeRound([0, width]);
      var y = d3.scale.ordinal().rangeRoundPoints([height, 0]);

      var xAxis = d3.svg.axis().scale(x).orient('bottom');
      var yAxis = d3.svg.axis().scale(y).orient('left');

    }

    function getQuestionDomain(iQuestionNum) {

      var result = [];

      var curQuestion = _.find(questions, {'question': iQuestionNum});
      if (curQuestion.type === 'choice') {
        result = _.map(curQuestion.attributes.question_choice_options, 'title');
      } else if (curQuestion.type === 'range') {
        result = [curQuestion.attributes.min, curQuestion.attributes.max];
      }

      return result;

    }

    // For each response, combine answers to Q1 and Q2 into an array of response pairs.
    // Ex: [{response1answer1,response1answer2}, {response2answer1,response2answer2}, ...]
    function getResponseData(iQuestionNum1, iQuestionNum2) {

      var result = [];
      var q1Type = _.find(questions, {'question': iQuestionNum1}).type;
      var q2Type = _.find(questions, {'question': iQuestionNum2}).type;

      _.forEach(responses, function(response) {

        var curResult = {};

        _.forOwn(response, function(responseVal, question){

          // X
          if (Number(question.split('-')[0]) === Number(iQuestionNum1)) {
            if (responseVal !== '' || responseVal !== undefined) {
              if (q1Type === 'range') { responseVal = Number(responseVal); }
              curResult.x = responseVal;
            }
          }
          // Y
          if (Number(question.split('-')[0]) === Number(iQuestionNum2)) {
            if (responseVal !== '' || responseVal !== undefined) {
              if (q2Type === 'range') { responseVal = Number(responseVal); }
              curResult.y = responseVal;
            }
          }

        });

        // Check if result has X and Y before pushing.
        if (curResult.x !== undefined && curResult.y !== undefined) {
          result.push(curResult);
        }

      });

      return result;

    }

  </script>
</body>